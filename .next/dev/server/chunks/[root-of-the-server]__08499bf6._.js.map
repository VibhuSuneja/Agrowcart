{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/Agrowcart/AgrowCart/Agrowcart/Agrowcart/src/app/api/webhook/whatsapp/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\n// Initialize Gemini\r\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || \"\");\r\nconst model = genAI.getGenerativeModel({ model: \"gemini-1.5-flash\" });\r\n\r\n// Verify Webhook (Required by Meta)\r\nexport async function GET(req: NextRequest) {\r\n    const searchParams = req.nextUrl.searchParams;\r\n    const mode = searchParams.get(\"hub.mode\");\r\n    const token = searchParams.get(\"hub.verify_token\");\r\n    const challenge = searchParams.get(\"hub.challenge\");\r\n\r\n    const VERIFY_TOKEN = process.env.WHATSAPP_VERIFY_TOKEN || \"agrowcart_secret\";\r\n\r\n    if (mode && token) {\r\n        if (mode === \"subscribe\" && token === VERIFY_TOKEN) {\r\n            return new NextResponse(challenge, { status: 200 });\r\n        } else {\r\n            return new NextResponse(\"Forbidden\", { status: 403 });\r\n        }\r\n    }\r\n    return new NextResponse(\"Bad Request\", { status: 400 });\r\n}\r\n\r\nimport crypto from \"crypto\";\r\n\r\n// Handle Incoming Messages\r\nexport async function POST(req: NextRequest) {\r\n    console.log(\"-----------------------------------------\");\r\n    console.log(\"üö® WEBHOOK CALLED: \" + new Date().toLocaleTimeString());\r\n\r\n    try {\r\n        const rawBody = await req.text();\r\n        const body = JSON.parse(rawBody);\r\n        console.log(\"üì• RAW PAYLOAD RECEIVED:\", JSON.stringify(body, null, 2));\r\n\r\n        // 1. Cybersecurity Check: Signature Verification\r\n        const signature = req.headers.get(\"x-hub-signature-256\");\r\n        const appSecret = process.env.WHATSAPP_APP_SECRET;\r\n\r\n        if (appSecret && signature) {\r\n            const expectedSignature = crypto\r\n                .createHmac(\"sha256\", appSecret)\r\n                .update(rawBody)\r\n                .digest(\"hex\");\r\n\r\n            if (signature !== `sha256=${expectedSignature}`) {\r\n                console.warn(\"‚ö†Ô∏è Signature Mismatch - Security bypass active for testing\");\r\n            } else {\r\n                console.log(\"‚úÖ Signature Verified\");\r\n            }\r\n        }\r\n\r\n        // 2. Extract Message Data\r\n        const entry = body.entry?.[0];\r\n        const changes = entry?.changes?.[0];\r\n        const value = changes?.value;\r\n        const messages = value?.messages;\r\n\r\n        if (messages && messages.length > 0) {\r\n            const message = messages[0];\r\n            const from = message.from;\r\n            const type = message.type;\r\n\r\n            console.log(`üë§ From: ${from} | Type: ${type}`);\r\n\r\n            if (type === \"text\") {\r\n                const textBody = message.text?.body;\r\n                console.log(`üí¨ Text Content: \"${textBody}\"`);\r\n\r\n                await sendWhatsAppMessage(from, `üëã Welcome to AgrowCart! \\n\\nI am your AI Assistant. I received your message: \"${textBody}\"\\n\\nHow can I help you with your millets today? üåæ`);\r\n            } else if (type === \"image\") {\r\n                console.log(\"üñºÔ∏è Image received - starting analysis...\");\r\n                await sendWhatsAppMessage(from, \"üîç I see an image! Analyzing crop health / quality...\");\r\n            }\r\n        } else {\r\n            console.log(\"‚ÑπÔ∏è Received a status update or other non-message event.\");\r\n        }\r\n\r\n        return new NextResponse(\"EVENT_RECEIVED\", { status: 200 });\r\n    } catch (error: any) {\r\n        console.error(\"‚ùå WEBHOOK CRASH:\", error.message);\r\n        return new NextResponse(\"Error\", { status: 500 });\r\n    }\r\n}\r\n\r\n// --- Helper Functions ---\r\n\r\n// 1. Send Message back to User\r\nasync function sendWhatsAppMessage(to: string, text: string) {\r\n    const token = process.env.WHATSAPP_API_TOKEN?.trim();\r\n    const phoneId = process.env.WHATSAPP_PHONE_ID?.trim();\r\n\r\n    if (!token || !phoneId) {\r\n        console.error(\"‚ùå ERROR: WhatsApp Env vars missing\");\r\n        return;\r\n    }\r\n\r\n    const payload = {\r\n        messaging_product: \"whatsapp\",\r\n        recipient_type: \"individual\",\r\n        to: to,\r\n        type: \"text\",\r\n        text: { body: text },\r\n    };\r\n\r\n    console.log(\"üöÄ SENDING TO META:\", JSON.stringify(payload, null, 2));\r\n\r\n    try {\r\n        const response = await fetch(`https://graph.facebook.com/v22.0/${phoneId}/messages`, {\r\n            method: \"POST\",\r\n            headers: {\r\n                \"Authorization\": `Bearer ${token}`,\r\n                \"Content-Type\": \"application/json\",\r\n            },\r\n            body: JSON.stringify(payload),\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!response.ok) {\r\n            console.log(\"**************************************************\");\r\n            console.error(\"‚ùå META API REJECTED MESSAGE!\");\r\n            console.error(\"Error Details:\", JSON.stringify(data, null, 2));\r\n            console.log(\"**************************************************\");\r\n        } else {\r\n            console.log(\"‚úÖ Message delivered by Meta!\");\r\n        }\r\n    } catch (err: any) {\r\n        console.error(\"‚ùå Network error while sending WhatsApp message:\", err.message);\r\n    }\r\n}\r\n\r\n// 2. Get Media URL from Meta\r\nasync function getWhatsAppMediaUrl(mediaId: string): Promise<string> {\r\n    const token = process.env.WHATSAPP_API_TOKEN;\r\n    const res = await fetch(`https://graph.facebook.com/v17.0/${mediaId}`, {\r\n        headers: { \"Authorization\": `Bearer ${token}` }\r\n    });\r\n    const data = await res.json();\r\n    return data.url; // Note: This URL requires auth to download, usually you download to buffer then send to Gemini\r\n}\r\n\r\n// 3. Mock Analysis (In real app, you download image buffer -> Gemini)\r\nasync function analyzeImageWithGemini(imageUrl: string) {\r\n    // In a real implementation:\r\n    // 1. Download image from imageUrl (using Bearer token)\r\n    // 2. Send buffer to Gemini\r\n\r\n    // For demo/prototype:\r\n    return {\r\n        crop: \"Finger Millet (Ragi)\",\r\n        quality: \"Premium Grade A\",\r\n        price: \"32\"\r\n    };\r\n}\r\n"],"names":[],"mappings":"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"}}]
}