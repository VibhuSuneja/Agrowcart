{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///D:/Agrowcart/AgrowCart/Agrowcart/Agrowcart/src/lib/gemini.ts"],"sourcesContent":["import { GoogleGenerativeAI } from \"@google/generative-ai\";\r\n\r\nconst apiKey = process.env.GEMINI_API_KEY;\r\nif (!apiKey) {\r\n    console.warn(\"GEMINI_API_KEY not found in environment variables\");\r\n}\r\n\r\nconst genAI = new GoogleGenerativeAI(apiKey || \"\");\r\n\r\nexport const model = genAI.getGenerativeModel({ model: \"gemini-1.5-flash\" });\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc;AACzC,IAAI,CAAC,QAAQ;IACT,QAAQ,IAAI,CAAC;AACjB;AAEA,MAAM,QAAQ,IAAI,sLAAkB,CAAC,UAAU;AAExC,MAAM,QAAQ,MAAM,kBAAkB,CAAC;IAAE,OAAO;AAAmB"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///D:/Agrowcart/AgrowCart/Agrowcart/Agrowcart/src/models/ai-cache.model.ts"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\ninterface IAIResponse {\r\n    key: string;      // Unique key (e.g., \"price-ragi-mandya\")\r\n    promptHash: string;\r\n    response: string; // JSON stringified response\r\n    expiry: Date;\r\n}\r\n\r\nconst aiResponseSchema = new mongoose.Schema<IAIResponse>({\r\n    key: { type: String, required: true, unique: true },\r\n    promptHash: { type: String, required: true },\r\n    response: { type: String, required: true },\r\n    expiry: { type: Date, required: true }\r\n}, { timestamps: true });\r\n\r\n// Index for automatic deletion after expiry\r\naiResponseSchema.index({ expiry: 1 }, { expireAfterSeconds: 0 });\r\n\r\nconst AIResponse = mongoose.models.AIResponse || mongoose.model(\"AIResponse\", aiResponseSchema);\r\n\r\nexport default AIResponse;\r\n"],"names":[],"mappings":";;;;AAAA;;AASA,MAAM,mBAAmB,IAAI,oHAAQ,CAAC,MAAM,CAAc;IACtD,KAAK;QAAE,MAAM;QAAQ,UAAU;QAAM,QAAQ;IAAK;IAClD,YAAY;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC3C,UAAU;QAAE,MAAM;QAAQ,UAAU;IAAK;IACzC,QAAQ;QAAE,MAAM;QAAM,UAAU;IAAK;AACzC,GAAG;IAAE,YAAY;AAAK;AAEtB,4CAA4C;AAC5C,iBAAiB,KAAK,CAAC;IAAE,QAAQ;AAAE,GAAG;IAAE,oBAAoB;AAAE;AAE9D,MAAM,aAAa,oHAAQ,CAAC,MAAM,CAAC,UAAU,IAAI,oHAAQ,CAAC,KAAK,CAAC,cAAc;uCAE/D"}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///D:/Agrowcart/AgrowCart/Agrowcart/Agrowcart/src/lib/db.ts"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst mongodbUrl=process.env.MONGODB_URL\r\n\r\nif(!mongodbUrl){\r\n throw new Error(\"db error\")\r\n}\r\n\r\n\r\n\r\nlet cached=global.mongoose\r\nif(!cached){\r\n    cached=global.mongoose={conn:null,promise:null}\r\n}\r\n\r\nconst connectDb=async ()=>{\r\n    if(cached.conn){\r\n       \r\n        return cached.conn\r\n    }\r\n\r\n    if(!cached.promise){\r\n      \r\n        cached.promise=mongoose.connect(mongodbUrl).then((conn)=>conn.connection)\r\n    }\r\n    try {\r\n        const conn=await cached.promise\r\n        return conn\r\n    } catch (error) {\r\n        console.log(error)\r\n    }\r\n\r\n}\r\n\r\nexport default connectDb"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,aAAW,QAAQ,GAAG,CAAC,WAAW;AAExC,IAAG,CAAC,YAAW;IACd,MAAM,IAAI,MAAM;AACjB;AAIA,IAAI,SAAO,yDAAO,QAAQ;AAC1B,IAAG,CAAC,QAAO;IACP,SAAO,yDAAO,QAAQ,GAAC;QAAC,MAAK;QAAK,SAAQ;IAAI;AAClD;AAEA,MAAM,YAAU;IACZ,IAAG,OAAO,IAAI,EAAC;QAEX,OAAO,OAAO,IAAI;IACtB;IAEA,IAAG,CAAC,OAAO,OAAO,EAAC;QAEf,OAAO,OAAO,GAAC,oHAAQ,CAAC,OAAO,CAAC,YAAY,IAAI,CAAC,CAAC,OAAO,KAAK,UAAU;IAC5E;IACA,IAAI;QACA,MAAM,OAAK,MAAM,OAAO,OAAO;QAC/B,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,QAAQ,GAAG,CAAC;IAChB;AAEJ;uCAEe"}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///D:/Agrowcart/AgrowCart/Agrowcart/Agrowcart/src/app/api/ai/farmer-advice/route.ts"],"sourcesContent":["import { model } from \"@/lib/gemini\";\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport AIResponse from \"@/models/ai-cache.model\";\r\nimport connectDb from \"@/lib/db\";\r\nimport crypto from \"crypto\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        await connectDb();\r\n        const { weatherData } = await req.json();\r\n\r\n        if (!weatherData || !weatherData.daily) {\r\n            return NextResponse.json({ message: \"Weather data is required\" }, { status: 400 });\r\n        }\r\n\r\n        const prompt = `\r\n        You are an expert Agricultural Advisor specialized in Millets and sustainable farming.\r\n        \r\n        Here is the 7-day weather forecast for the region:\r\n        ${JSON.stringify(weatherData)}\r\n\r\n        Based on this forecast (Temperature, Rainfall, Humidity), provide specific, actionable advice for Millet farmers.\r\n        \r\n        Structure your response as a small JSON object with these keys:\r\n        - \"summary\": A 1-sentence summary of the week's outlook for crops.\r\n        - \"action\": ONE clear action item for the farmer (e.g., \"Irrigate lightly on Tuesday\", \"Apply neem oil due to humidity\", \"Harvest immediately\").\r\n        - \"risk\": Any potential risk (e.g., \"High fungal risk\", \"Heat stress\").\r\n\r\n        Keep it very concise. output ONLY valid JSON.\r\n        `;\r\n\r\n        // 1. Caching Layer\r\n        const promptHash = crypto.createHash('md5').update(prompt).digest('hex');\r\n        // Cache key based on the first day's max temp and date to avoid stale advice if location changes\r\n        const firstDay = weatherData.daily[0];\r\n        const cacheKey = `advice-${firstDay.date}-${firstDay.maxTemp}`.toLowerCase().replace(/\\s+/g, '-');\r\n\r\n        const existingCache = await AIResponse.findOne({ key: cacheKey });\r\n        if (existingCache && existingCache.expiry > new Date()) {\r\n            console.log(\"ðŸš€ Serving Advisory from Cache\");\r\n            return NextResponse.json({ advice: JSON.parse(existingCache.response) }, { status: 200 });\r\n        }\r\n\r\n        // 2. AI Generation\r\n        try {\r\n            const result = await model.generateContent(prompt);\r\n            const response = await result.response;\r\n            const text = response.text();\r\n\r\n            // Cleanup markdown if present to parse JSON\r\n            const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();\r\n            const advice = JSON.parse(jsonStr);\r\n\r\n            // 3. Store in Cache (Expires in 12 hours for weather)\r\n            await AIResponse.findOneAndUpdate(\r\n                { key: cacheKey },\r\n                {\r\n                    promptHash,\r\n                    response: JSON.stringify(advice),\r\n                    expiry: new Date(Date.now() + 12 * 60 * 60 * 1000)\r\n                },\r\n                { upsert: true }\r\n            );\r\n\r\n            return NextResponse.json({ advice }, { status: 200 });\r\n        } catch (aiError) {\r\n            console.error(\"Gemini Advice Error:\", aiError);\r\n            throw aiError; // Trigger fallback below\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error(\"AI Weather Error:\", error);\r\n\r\n        // Fallback Advice to prevent \"Offline\" message\r\n        const fallbackAdvice = {\r\n            summary: \"Weather patterns are stable for millet growth.\",\r\n            action: \"Monitor soil moisture levels daily.\",\r\n            risk: \"Minimal immediate risk detected.\"\r\n        };\r\n\r\n        return NextResponse.json({ advice: fallbackAdvice }, { status: 200 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,KAAK,GAAgB;IACvC,IAAI;QACA,MAAM,IAAA,6HAAS;QACf,MAAM,EAAE,WAAW,EAAE,GAAG,MAAM,IAAI,IAAI;QAEtC,IAAI,CAAC,eAAe,CAAC,YAAY,KAAK,EAAE;YACpC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,MAAM,SAAS,CAAC;;;;QAIhB,EAAE,KAAK,SAAS,CAAC,aAAa;;;;;;;;;;QAU9B,CAAC;QAED,mBAAmB;QACnB,MAAM,aAAa,gHAAM,CAAC,UAAU,CAAC,OAAO,MAAM,CAAC,QAAQ,MAAM,CAAC;QAClE,iGAAiG;QACjG,MAAM,WAAW,YAAY,KAAK,CAAC,EAAE;QACrC,MAAM,WAAW,CAAC,OAAO,EAAE,SAAS,IAAI,CAAC,CAAC,EAAE,SAAS,OAAO,EAAE,CAAC,WAAW,GAAG,OAAO,CAAC,QAAQ;QAE7F,MAAM,gBAAgB,MAAM,kJAAU,CAAC,OAAO,CAAC;YAAE,KAAK;QAAS;QAC/D,IAAI,iBAAiB,cAAc,MAAM,GAAG,IAAI,QAAQ;YACpD,QAAQ,GAAG,CAAC;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,QAAQ,KAAK,KAAK,CAAC,cAAc,QAAQ;YAAE,GAAG;gBAAE,QAAQ;YAAI;QAC3F;QAEA,mBAAmB;QACnB,IAAI;YACA,MAAM,SAAS,MAAM,+HAAK,CAAC,eAAe,CAAC;YAC3C,MAAM,WAAW,MAAM,OAAO,QAAQ;YACtC,MAAM,OAAO,SAAS,IAAI;YAE1B,4CAA4C;YAC5C,MAAM,UAAU,KAAK,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;YACrE,MAAM,SAAS,KAAK,KAAK,CAAC;YAE1B,sDAAsD;YACtD,MAAM,kJAAU,CAAC,gBAAgB,CAC7B;gBAAE,KAAK;YAAS,GAChB;gBACI;gBACA,UAAU,KAAK,SAAS,CAAC;gBACzB,QAAQ,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK;YACjD,GACA;gBAAE,QAAQ;YAAK;YAGnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE;YAAO,GAAG;gBAAE,QAAQ;YAAI;QACvD,EAAE,OAAO,SAAS;YACd,QAAQ,KAAK,CAAC,wBAAwB;YACtC,MAAM,SAAS,yBAAyB;QAC5C;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QAEnC,+CAA+C;QAC/C,MAAM,iBAAiB;YACnB,SAAS;YACT,QAAQ;YACR,MAAM;QACV;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;QAAe,GAAG;YAAE,QAAQ;QAAI;IACvE;AACJ"}}]
}